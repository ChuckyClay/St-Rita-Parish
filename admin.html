 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - St. Rita Parish</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand"><h1>Admin Panel</h1></div>
    <button id="logout-btn" style="display:none;position:absolute;top:20px;right:20px;">Logout</button>
  </header>
  <main class="container admin-panel">
    <section id="auth-section" class="card admin-card">
      <h2 class="admin-title">Admin Login</h2>
      <form id="admin-login-form" class="admin-form">
        <input type="hidden" id="admin-username" value="admin" />
        <label for="admin-password">Password:</label>
        <input type="password" id="admin-password" required />
        <button type="submit" class="admin-btn">Login</button>
      </form>
      <div id="auth-error" class="small muted" style="color:red;margin-top:10px;"></div>
    </section>
    <section id="admin-content" style="display:none;">
    // Media upload logic removed
      }
      logoutBtn.addEventListener('click', function() {
        localStorage.removeItem('jwtToken');
        showLogin();
        updateLogoutBtn();
      });

      document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const pw = document.getElementById('admin-password').value;
        const username = document.getElementById('admin-username').value;
        document.getElementById('auth-error').textContent = '';
        try {
          const res = await fetch('http://localhost:3000/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password: pw })
          });
          if (!res.ok) {
            const data = await res.json();
            throw new Error(data.error || 'Login failed');
          }
          const data = await res.json();
          localStorage.setItem('jwtToken', data.token);
          showAdminContent();
          updateLogoutBtn();
        } catch (err) {
          document.getElementById('auth-error').textContent = err.message;
        }
      });

      // ...existing code...
    });

    // Announcement logic (backend) with edit, search, and pagination
    const annForm = document.getElementById('ann-form');
    const annList = document.getElementById('ann-list');
    const annSearch = document.getElementById('ann-search');
    const annCancelEdit = document.getElementById('ann-cancel-edit');
    let editingAnnId = null;
    let allAnns = [];
    let annPage = 1;
    const ANNS_PER_PAGE = 5;

    async function loadAnns() {
      if (!annList) return;
      annList.innerHTML = '<li>Loading...</li>';
      try {
        const res = await fetch('http://localhost:3000/api/announcements');
        if (!res.ok) throw new Error('Failed to load announcements');
        allAnns = await res.json();
        renderAnnList();
      } catch (err) {
        annList.innerHTML = `<li>${err.message}</li>`;
      }
    }

    function renderAnnList() {
      let filtered = allAnns;
      const q = annSearch.value.trim().toLowerCase();
      if (q) {
        filtered = filtered.filter(a =>
          a.content.toLowerCase().includes(q) ||
          (a.title && a.title.toLowerCase().includes(q))
        );
      }
      const start = (annPage - 1) * ANNS_PER_PAGE;
      const paged = filtered.slice(start, start + ANNS_PER_PAGE);
      annList.innerHTML = paged.map(a =>
        `<li><b>${a.title || 'Announcement'}</b> (${a.date ? a.date.split('T')[0] : ''})<br>${a.content}<br>
        <button data-id="${a.id}" class="edit-ann-btn">Edit</button>
        <button data-id="${a.id}" class="delete-ann-btn">Delete</button></li>`
      ).join('') || '<li>No announcements found.</li>';
      // Pagination controls
      const totalPages = Math.ceil(filtered.length / ANNS_PER_PAGE);
      if (totalPages > 1) {
        let pag = '<div style="margin-top:8px;">';
        for (let i = 1; i <= totalPages; i++) {
          pag += `<button class="admin-btn" style="margin:2px;${i===annPage?'background:#1976d2;color:#fff;':''}" data-ann-page="${i}">${i}</button>`;
        }
        pag += '</div>';
        annList.innerHTML += pag;
      }
    }

    annList.addEventListener('click', async e => {
      const jwtToken = localStorage.getItem('jwtToken') || '';
      if (e.target.classList.contains('delete-ann-btn')) {
        const id = e.target.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Delete this announcement?')) return;
        try {
          const res = await fetch(`http://localhost:3000/api/announcements/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + jwtToken }
          });
          if (!res.ok) {
            if (res.status === 401) {
              showLogin();
              throw new Error('Session expired. Please log in again.');
            }
            const data = await res.json();
            throw new Error(data.error || 'Failed to delete announcement');
          }
          loadAnns();
        } catch (err) {
          alert(err.message);
        }
      } else if (e.target.classList.contains('edit-ann-btn')) {
        const id = e.target.getAttribute('data-id');
        const a = allAnns.find(a => a.id == id);
        if (!a) return;
        editingAnnId = id;
        document.getElementById('ann-id').value = id;
        document.getElementById('ann-text').value = a.content;
        annCancelEdit.style.display = '';
      } else if (e.target.dataset.annPage) {
        annPage = parseInt(e.target.dataset.annPage);
        renderAnnList();
      }
    });

    annSearch.addEventListener('input', () => {
      annPage = 1;
      renderAnnList();
    });

    annCancelEdit.addEventListener('click', () => {
      editingAnnId = null;
      annForm.reset();
      annCancelEdit.style.display = 'none';
    });

    if (annForm) {
      annForm.addEventListener('submit', async e => {
        e.preventDefault();
        const jwtToken = localStorage.getItem('jwtToken') || '';
        const t = document.getElementById('ann-text').value.trim();
        const successDiv = document.getElementById('ann-success');
        if (!t) {
          successDiv.textContent = 'Enter announcement.';
          successDiv.style.color = 'red';
          return;
        }
        try {
          let res;
          if (editingAnnId) {
            res = await fetch(`http://localhost:3000/api/announcements/${editingAnnId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + jwtToken
              },
              body: JSON.stringify({ title: 'Announcement', content: t })
            });
          } else {
            res = await fetch('http://localhost:3000/api/announcements', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + jwtToken
              },
              body: JSON.stringify({ title: 'Announcement', content: t, date: new Date().toISOString() })
            });
          }
          if (!res.ok) {
            if (res.status === 401) {
              showLogin();
              throw new Error('Session expired. Please log in again.');
            }
            const data = await res.json();
            throw new Error(data.error || 'Failed to save announcement');
          }
          document.getElementById('ann-text').value = '';
          editingAnnId = null;
          annCancelEdit.style.display = 'none';
          successDiv.textContent = 'Saved announcement.';
          successDiv.style.color = 'green';
          setTimeout(() => { successDiv.textContent = ''; }, 4000);
          loadAnns();
        } catch (err) {
          successDiv.textContent = err.message;
          successDiv.style.color = 'red';
        }
      });
      loadAnns();
    }

    // Message logic (backend)
    const messForm = document.getElementById('mess-form');
    const status = document.getElementById('sms-status');
    if (messForm) {
      messForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const jwtToken = localStorage.getItem('jwtToken') || '';
        const message = document.getElementById('mess-text').value.trim();
        const successDiv = document.getElementById('mess-success');
        if (!message) {
          successDiv.textContent = 'Enter a message to send.';
          successDiv.style.color = 'red';
          return;
        }
        status.textContent = 'Attempting to send...';
        try {
          const res = await fetch('http://localhost:3000/api/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify({ message })
          });
          if (!res.ok) {
            if (res.status === 401) {
              showLogin();
              throw new Error('Session expired. Please log in again.');
            }
            const data = await res.json();
            throw new Error(data.error || 'Failed to send message');
          }
          status.textContent = 'Message sent to subscribers.';
          successDiv.textContent = 'Message sent.';
          successDiv.style.color = 'green';
          setTimeout(() => { successDiv.textContent = ''; }, 4000);
        } catch (err) {
          status.textContent = 'SMS failed: ' + err.message;
          successDiv.textContent = err.message;
          successDiv.style.color = 'red';
        }
      });
    }

    // NEW MEDIA UPLOAD LOGIC (robust, announcement/event style)
      // Media upload logic removed

    // Show subscribed phone numbers (backend)
    async function renderPhoneList() {
      const jwtToken = localStorage.getItem('jwtToken') || '';
      const phoneList = document.getElementById('phone-list');
      phoneList.innerHTML = '<li>Loading...</li>';
      try {
        const res = await fetch('http://localhost:3000/api/phones', {
          headers: { 'Authorization': 'Bearer ' + jwtToken }
        });
        if (!res.ok) {
          if (res.status === 401) {
            showLogin();
            throw new Error('Session expired. Please log in again.');
          }
          throw new Error('Failed to load phone numbers');
        }
        const phones = await res.json();
        phoneList.innerHTML = Array.isArray(phones) && phones.length
          ? phones.map(p => `<li>${p}</li>`).join('')
          : '<li>No numbers subscribed.</li>';
      } catch (err) {
        phoneList.innerHTML = `<li>${err.message}</li>`;
      }
    }
    renderPhoneList();
  </script>
</body>
</html>