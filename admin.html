<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - St. Rita Parish</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand"><h1>Admin Panel</h1></div>
    <button id="logout-btn" style="display:none;position:absolute;top:20px;right:20px;">Logout</button>
  </header>
  <main class="container admin-panel">
    <section id="auth-section" class="card admin-card">
      <h2 class="admin-title">Admin Login</h2>
      <form id="admin-login-form" class="admin-form">
        <input type="hidden" id="admin-username" value="admin" />
        <label for="admin-password">Password:</label>
        <input type="password" id="admin-password" required />
        <button type="submit" class="admin-btn">Login</button>
      </form>
      <div id="auth-error" class="small muted" style="color:red;margin-top:10px;"></div>
    </section>
    <section id="admin-content" style="display:none;">
      <div class="admin-sections">
        <section class="card admin-card">
          <h2 class="admin-title">Announcements</h2>
          <form id="ann-form" class="admin-form">
            <label for="ann-text">Text</label>
            <input id="ann-text" placeholder="Announcement text" />
            <button type="submit" class="admin-btn">Save Announcement</button>
            <div id="ann-success" class="small muted" style="margin-top:10px"></div>
          </form>
        </section>
        <section class="card admin-card">
          <h2 class="admin-title">Events</h2>
          <form id="event-form" class="admin-form">
            <label for="event-title">Title</label>
            <input id="event-title" placeholder="Event title" />
            <label for="event-date">Date</label>
            <input id="event-date" type="date" />
            <label for="event-time">Time</label>
            <input id="event-time" type="time" />
            <label for="event-desc">Description</label>
            <textarea id="event-desc" placeholder="Event description" rows="2"></textarea>
            <button type="submit" class="admin-btn">Save Event</button>
            <div id="event-success" class="small muted" style="margin-top:10px"></div>
          </form>
          <div class="admin-divider"></div>
          <h3>Delete Event</h3>
          <ul id="event-list" class="small muted"></ul>
          <div id="event-delete-success" class="small muted" style="margin-top:10px"></div>
        </section>
        <section class="card admin-card">
          <h2 class="admin-title">Send Message</h2>
          <form id="mess-form" class="admin-form">
            <label for="mess-text">Message</label>
            <textarea id="mess-text" placeholder="Message text" rows="3"></textarea>
            <button type="submit" class="admin-btn">Send Message</button>
            <div id="mess-success" class="small muted" style="margin-top:10px"></div>
          </form>
          <div id="sms-status" class="small muted" style="margin-top:10px"></div>
        </section>
        <section class="card admin-card">
          <h2 class="admin-title">Upload Media</h2>
          <form id="media-form" class="admin-form" enctype="multipart/form-data">
            <label for="media-files">Select Images or Videos</label>
            <input id="media-files" name="mediaFiles" type="file" accept="image/*,video/*" multiple required />
            <label for="media-caption">Caption (optional, applies to all)</label>
            <input id="media-caption" placeholder="Caption" />
            <label for="media-event">Event (optional, applies to all)</label>
            <input id="media-event" placeholder="e.g. easter" />
            <label for="media-date">Date (optional, applies to all)</label>
            <input id="media-date" type="date" />
            <button type="submit" class="admin-btn">Upload</button>
            <div id="media-success" class="small muted" style="margin-top:10px"></div>
          </form>
          <div id="media-status" class="small muted" style="margin-top:10px"></div>
        </section>
        <section class="card admin-card">
          <h2 class="admin-title">Subscribed Phone Numbers</h2>
          <ul id="phone-list" class="small muted"></ul>
        </section>
      </div>
    </section>
  </main>
    <footer class="site-footer">&copy; St. Rita Parish <br> <i>Designed by DevTwins Developers</i></footer>

  <script>
    // All admin panel JavaScript moved here
    // Backend JWT authentication
    const authSection = document.getElementById('auth-section');
    const adminContent = document.getElementById('admin-content');
    let jwtToken = localStorage.getItem('jwtToken') || '';

    function showAdminContent() {
      authSection.style.display = 'none';
      adminContent.style.display = '';
    }
    function showLogin() {
      authSection.style.display = '';
      adminContent.style.display = 'none';
    }
    const logoutBtn = document.getElementById('logout-btn');
    function updateLogoutBtn() {
      if (jwtToken) {
        logoutBtn.style.display = '';
      } else {
        logoutBtn.style.display = 'none';
      }
    }
    if (jwtToken) {
      showAdminContent();
      updateLogoutBtn();
    }
    logoutBtn.addEventListener('click', function() {
      jwtToken = '';
      localStorage.removeItem('jwtToken');
      showLogin();
      updateLogoutBtn();
    });

    document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const pw = document.getElementById('admin-password').value;
      const username = document.getElementById('admin-username').value;
      document.getElementById('auth-error').textContent = '';
      try {
        const res = await fetch('http://localhost:3000/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password: pw })
        });
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Login failed');
        }
        const data = await res.json();
        jwtToken = data.token;
        localStorage.setItem('jwtToken', jwtToken);
        showAdminContent();
        updateLogoutBtn();
      } catch (err) {
        document.getElementById('auth-error').textContent = err.message;
      }
    });

    // Event logic (backend)
    const eventForm = document.getElementById('event-form');
    const eventList = document.getElementById('event-list');
    const eventDeleteSuccess = document.getElementById('event-delete-success');
    async function loadEventsForDelete() {
      if (!eventList) return;
      eventList.innerHTML = '<li>Loading...</li>';
      try {
        const res = await fetch('http://localhost:3000/api/events');
        if (!res.ok) throw new Error('Failed to load events');
        const events = await res.json();
        if (!Array.isArray(events) || events.length === 0) {
          eventList.innerHTML = '<li>No events found.</li>';
          return;
        }
        eventList.innerHTML = events.map(ev =>
          `<li>${ev.title} (${ev.date} ${ev.time}) <button data-id="${ev.id}" class="delete-event-btn">Delete</button></li>`
        ).join('');
      } catch (err) {
        eventList.innerHTML = `<li>${err.message}</li>`;
      }
    }
    if (eventList) {
      eventList.addEventListener('click', async e => {
        if (e.target.classList.contains('delete-event-btn')) {
          const id = e.target.getAttribute('data-id');
          if (!id) return;
          if (!confirm('Delete this event?')) return;
          try {
            const res = await fetch(`http://localhost:3000/api/events/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!res.ok) {
              if (res.status === 401) {
                showLogin();
                throw new Error('Session expired. Please log in again.');
              }
              const data = await res.json();
              throw new Error(data.error || 'Failed to delete event');
            }
            eventDeleteSuccess.textContent = 'Event deleted.';
            eventDeleteSuccess.style.color = 'green';
            setTimeout(() => { eventDeleteSuccess.textContent = ''; }, 3000);
            loadEventsForDelete();
          } catch (err) {
            eventDeleteSuccess.textContent = err.message;
            eventDeleteSuccess.style.color = 'red';
          }
        }
      });
    }
    if (eventForm) {
      eventForm.addEventListener('submit', async e => {
        e.preventDefault();
        const title = document.getElementById('event-title').value.trim();
        const date = document.getElementById('event-date').value;
        const time = document.getElementById('event-time').value;
        const description = document.getElementById('event-desc').value.trim();
        const successDiv = document.getElementById('event-success');
        if (!title || !date || !time || !description) {
          successDiv.textContent = 'Please fill all fields.';
          successDiv.style.color = 'red';
          return;
        }
        try {
          const res = await fetch('http://localhost:3000/api/events', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify({ title, date, time, description })
          });
          if (!res.ok) {
            if (res.status === 401) {
              showLogin();
              throw new Error('Session expired. Please log in again.');
            }
            const data = await res.json();
            throw new Error(data.error || 'Failed to save event');
          }
          eventForm.reset();
          successDiv.textContent = 'Saved event.';
          successDiv.style.color = 'green';
          setTimeout(() => { successDiv.textContent = ''; }, 4000);
          loadEventsForDelete();
        } catch (err) {
          successDiv.textContent = err.message;
          successDiv.style.color = 'red';
        }
      });
      // Load events for deletion on page load
      loadEventsForDelete();
    }

    // Announcement logic (backend)
    const annForm = document.getElementById('ann-form');
    annForm.addEventListener('submit', async e => {
      e.preventDefault();
      const t = document.getElementById('ann-text').value.trim();
      const successDiv = document.getElementById('ann-success');
      if (!t) {
        successDiv.textContent = 'Enter announcement.';
        successDiv.style.color = 'red';
        return;
      }
      try {
        const res = await fetch('http://localhost:3000/api/announcements', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + jwtToken
          },
          body: JSON.stringify({ title: 'Announcement', content: t, date: new Date().toISOString() })
        });
        if (!res.ok) {
          if (res.status === 401) {
            showLogin();
            throw new Error('Session expired. Please log in again.');
          }
          const data = await res.json();
          throw new Error(data.error || 'Failed to save announcement');
        }
        document.getElementById('ann-text').value = '';
        successDiv.textContent = 'Saved announcement.';
        successDiv.style.color = 'green';
        setTimeout(() => { successDiv.textContent = ''; }, 4000);
      } catch (err) {
        successDiv.textContent = err.message;
        successDiv.style.color = 'red';
      }
    });

    // Message logic (backend)
    const messForm = document.getElementById('mess-form');
    const status = document.getElementById('sms-status');
    if (messForm) {
      messForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = document.getElementById('mess-text').value.trim();
        const successDiv = document.getElementById('mess-success');
        if (!message) {
          successDiv.textContent = 'Enter a message to send.';
          successDiv.style.color = 'red';
          return;
        }
        status.textContent = 'Attempting to send...';
        try {
          const res = await fetch('http://localhost:3000/api/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify({ message })
          });
          if (!res.ok) {
            if (res.status === 401) {
              showLogin();
              throw new Error('Session expired. Please log in again.');
            }
            const data = await res.json();
            throw new Error(data.error || 'Failed to send message');
          }
          status.textContent = 'Message sent to subscribers.';
          successDiv.textContent = 'Message sent.';
          successDiv.style.color = 'green';
          setTimeout(() => { successDiv.textContent = ''; }, 4000);
        } catch (err) {
          status.textContent = 'SMS failed: ' + err.message;
          successDiv.textContent = err.message;
          successDiv.style.color = 'red';
        }
      });
    }

    // Media upload logic (backend)
    const mediaForm = document.getElementById('media-form');
    if (mediaForm) {
      mediaForm.addEventListener('submit', async e => {
        e.preventDefault();
        const files = document.getElementById('media-files').files;
        const caption = document.getElementById('media-caption').value.trim();
        const event = document.getElementById('media-event').value.trim();
        const date = document.getElementById('media-date').value;
        const successDiv = document.getElementById('media-success');
        if (!files.length) {
          successDiv.textContent = 'Please select at least one file.';
          successDiv.style.color = 'red';
          return;
        }
        // 1. Upload files to /api/media/upload
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
          formData.append('mediaFiles', files[i]);
        }
        let uploadedFiles;
        try {
          const uploadRes = await fetch('http://localhost:3000/api/media/upload', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + jwtToken
            },
            body: formData
          });
          if (!uploadRes.ok) {
            if (uploadRes.status === 401) {
              showLogin();
              throw new Error('Session expired. Please log in again.');
            }
            const data = await uploadRes.json();
            throw new Error(data.error || 'Failed to upload files');
          }
          const data = await uploadRes.json();
          uploadedFiles = data.files;
        } catch (err) {
          successDiv.textContent = err.message;
          successDiv.style.color = 'red';
          return;
        }
        // 2. Save metadata for each file to /api/media
        let allSuccess = true;
        for (const file of uploadedFiles) {
          const type = file.mimetype.startsWith('image') ? 'image' : 'video';
          const meta = {
            type,
            src: file.path,
            caption: caption || file.originalname,
            event: event || '',
            date: date || new Date().toISOString().split('T')[0]
          };
          try {
            const res = await fetch('http://localhost:3000/api/media', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + jwtToken
              },
              body: JSON.stringify(meta)
            });
            if (!res.ok) {
              allSuccess = false;
            }
          } catch {
            allSuccess = false;
          }
        }
        if (allSuccess) {
          successDiv.textContent = 'Media uploaded.';
          successDiv.style.color = 'green';
          mediaForm.reset();
          setTimeout(() => { successDiv.textContent = ''; }, 4000);
        } else {
          successDiv.textContent = 'Some files failed to save metadata.';
          successDiv.style.color = 'orange';
        }
      });
    }

    // Show subscribed phone numbers (backend)
    async function renderPhoneList() {
      const phoneList = document.getElementById('phone-list');
      phoneList.innerHTML = '<li>Loading...</li>';
      try {
        const res = await fetch('http://localhost:3000/api/phones', {
          headers: { 'Authorization': 'Bearer ' + jwtToken }
        });
        if (!res.ok) {
          if (res.status === 401) {
            showLogin();
            throw new Error('Session expired. Please log in again.');
          }
          throw new Error('Failed to load phone numbers');
        }
        const phones = await res.json();
        phoneList.innerHTML = Array.isArray(phones) && phones.length
          ? phones.map(p => `<li>${p}</li>`).join('')
          : '<li>No numbers subscribed.</li>';
      } catch (err) {
        phoneList.innerHTML = `<li>${err.message}</li>`;
      }
    }
    renderPhoneList();
  </script>
</body>
</html>